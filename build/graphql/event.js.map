{"version":3,"sources":["../../src/graphql/event.js"],"names":["typeDefs","gql","resolvers","Query","event","_","args","eventShortcut","find","id","events","findAll","map","eventObject","allEvents","findAllDeleted","userEvents","_parent","_args","context","AuthenticationError","errors","NOT_LOGGED","user","userShortcut","database","models","label","DEFAULT","userLabelIds","labels","findAllByLabelIds","ownedEvents","findWithRole","userOwnedEvents","model","where","labelEvents","labelRelatedEvents","labelShortcut","usersId","users","usersIdStr","join","length","labelsSQL","query","type","QueryTypes","SELECT","labelsId","l","Mutation","createEvent","input","startDate","Date","start","now","isBefore","UserInputError","subject","subjectShortcut","subject_id","Error","userOwnSubject","hasSubject","EVENT_TAKEN","label_id","labelUserIds","sql","toISOString","request","userIdsFromLabels","userIds","filter","includes","USER_EVENT_TAKEN","create","link","description","obligatory","setLabel","setSubject","setUser","updateEvent","loggedUser","userIsOwner","ForbiddenError","NOT_EVENT_OWNER","update","deleteEvent","deleted_at","destroyEvent","findDeleted","destroy"],"mappings":"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","sourcesContent":["/* eslint-disable no-unused-vars */\nimport { QueryTypes } from 'sequelize';\nimport { AuthenticationError, ForbiddenError, gql, UserInputError } from 'apollo-server-express';\n\nimport moment from 'moment';\n\nimport { eventObject } from '../utils/relationMapper';\nimport {\n  user as userShortcut,\n  label as labelShortcut,\n  role as roleShortcut,\n  subject as subjectShortcut,\n  event as eventShortcut,\n} from '../utils/shortcut';\nimport { checkIsAdmin, checkIsProfessor } from '../utils/authorization';\n\nimport config from '../config';\nimport errors from '../config/errors';\n\nimport database from '../database';\n\nexport const typeDefs = gql`\n  extend type Query {\n    event(id: ID!): Event\n    events: [Event!]\n\n    allEvents: [Event!]\n\n    userEvents: [Event!]\n    ownedEvents: [Event!]\n\n    labelEvents(id: ID!): [Event!]\n    labelRelatedEvents(id: ID!): [Event!]\n  }\n\n  extend type Mutation {\n    createEvent(input: EventInput): Event\n\n    updateEvent(id: ID!, description: String, link: String, obligatory: Boolean): Boolean\n\n    deleteEvent(id: ID!): Boolean\n    destroyEvent(id: ID!): Boolean\n  }\n\n  input EventInput {\n    start: String!\n    link: String\n    description: String!\n    obligatory: Boolean!\n    label_id: ID!\n    subject_id: ID!\n  }\n\n  type Event {\n    id: ID!\n    start: String!\n    link: String\n    description: String!\n    obligatory: Boolean!\n    owner: User\n    label: Label\n    subject: Subject\n    created_at: String!\n    updated_at: String\n    deleted_at: String\n  }\n`;\n\nexport const resolvers = {\n  Query: {\n    event: async (_, args) => {\n      const event = await eventShortcut.find(args.id);\n      return eventObject(event);\n    },\n\n    events: async () => {\n      const events = await eventShortcut.findAll();\n      return events.map(eventObject);\n    },\n\n    allEvents: async () => {\n      const events = await eventShortcut.findAllDeleted();\n      return events.map(eventObject);\n    },\n\n    userEvents: async (_parent, _args, context) => {\n      if (!context?.id) throw new AuthenticationError(errors.NOT_LOGGED);\n\n      const user = await userShortcut.find(context.id, database.models.label);\n      if (!user) throw new AuthenticationError(errors.DEFAULT);\n\n      const userLabelIds = user.labels.map((label) => label.id);\n\n      const events = await eventShortcut.findAllByLabelIds(userLabelIds);\n      return events.map(eventObject);\n    },\n\n    ownedEvents: async (_parent, _args, context) => {\n      if (!context?.id) throw new AuthenticationError(errors.NOT_LOGGED);\n\n      const user = await userShortcut.findWithRole(context.id);\n      await checkIsProfessor(user);\n\n      const userOwnedEvents = await eventShortcut.findAll({ model: database.models.user, where: { id: context.id } });\n      return userOwnedEvents.map(eventObject);\n    },\n\n    labelEvents: async (_parent, args, context) => {\n      if (!context?.id) throw new AuthenticationError(errors.NOT_LOGGED);\n\n      const user = await userShortcut.findWithRole(context.id);\n      await checkIsProfessor(user);\n\n      const labelEvents = await eventShortcut.findAll({ model: database.models.label, where: { id: args.id } });\n      return labelEvents.map(eventObject);\n    },\n\n    labelRelatedEvents: async (_parent, args, context) => {\n      if (!context?.id) throw new AuthenticationError(errors.NOT_LOGGED);\n\n      const user = await userShortcut.findWithRole(context.id);\n      await checkIsProfessor(user);\n\n      const label = await labelShortcut.find(args.id, [database.models.user]);\n      const usersId = await label.users.map((user) => user.id);\n\n      const usersIdStr = usersId.map((id) => `'${id}'`).join(', ');\n      if (usersIdStr.length === 0) return [];\n\n      const labelsSQL = `SELECT Label.id FROM UserLabels JOIN Label ON UserLabels.label_id = Label.id JOIN User ON UserLabels.user_id = User.id WHERE User.id IN(${usersIdStr})`;\n      const labels = await database.query(labelsSQL, { type: QueryTypes.SELECT });\n\n      const labelsId = labels.map((l) => l.id);\n\n      const events = await eventShortcut.findAll({ model: database.models.label, where: { id: labelsId } });\n      return events.map(eventObject);\n    },\n  },\n\n  Mutation: {\n    // TODO : [x] Verify permissions of user when creating the event (subject owning etc...)\n    // TODO : [x] Set the user & role detection into the jwt and the request.\n    // TODO : [x] Verify if there is already an event for this label at this time.\n    // TODO : [x] Redefined error messages.\n    // TODO : [x] Check if date is not before today.\n    // TODO : [ ] Check if date is a round date. (database collision problems)\n\n    createEvent: async (_, { input: args }, context) => {\n      if (!context?.id) throw new AuthenticationError(errors.NOT_LOGGED);\n\n      const startDate = moment(new Date(args.start));\n      const now = moment(Date.now());\n      if (startDate.isBefore(now)) throw new UserInputError(errors.DEFAULT);\n\n      const user = await userShortcut.findWithRole(context.id, [database.models.subject]);\n      await checkIsProfessor(user);\n\n      const subject = await subjectShortcut.find(args.subject_id);\n      if (!subject) throw new Error(errors.DEFAULT);\n\n      const userOwnSubject = await user.hasSubject(subject);\n      if (!userOwnSubject) throw new Error(errors.DEFAULT);\n\n      const userOwnedEvents = await eventShortcut.findAll({ model: database.models.user, where: { id: context.id } });\n      if (userOwnedEvents > 0) throw new UserInputError(errors.EVENT_TAKEN);\n\n      const label = await labelShortcut.find(args.label_id, [database.models.user]);\n      if (!label) throw new UserInputError(errors.DEFAULT);\n\n      // Select every user which the label contains.\n      const labelUserIds = await label.users.map((user) => user.id);\n\n      // SQL Request select id of every user which have an event which start at the given start time.\n      const sql = `SELECT User.id FROM Event JOIN Label ON Event.label_id = Label.id JOIN UserLabels ON UserLabels.label_id = Label.id JOIN User ON UserLabels.user_id = User.id WHERE Event.start = \"${startDate.toISOString()}\"`;\n      const request = await database.query(sql, { type: QueryTypes.SELECT });\n\n      const userIdsFromLabels = request.map((user) => user.id);\n\n      // Intersection of the label users and the events which have and event at the given start time.\n      const userIds = userIdsFromLabels.filter((id) => labelUserIds.includes(id));\n      if (userIds.length > 0) throw new UserInputError(errors.USER_EVENT_TAKEN);\n\n      const event = await database.models.event.create({\n        start: startDate.toISOString(),\n        link: args.link ? args.link : '',\n        description: args.description,\n        obligatory: args.obligatory,\n      });\n\n      await event.setLabel(label);\n\n      await event.setSubject(subject);\n      await event.setUser(user);\n\n      return eventObject(event);\n    },\n\n    updateEvent: async (_, args, context) => {\n      if (!context?.id) throw new AuthenticationError(errors.NOT_LOGGED);\n\n      const loggedUser = await userShortcut.findWithRole(context.id, [database.models.subject]);\n      await checkIsProfessor(loggedUser);\n\n      const event = await eventShortcut.find(args.id, [database.models.user]);\n      if (!event) throw new UserInputError(errors.DEFAULT);\n\n      const userIsOwner = event.user.id === loggedUser.id;\n      if (!userIsOwner) throw new ForbiddenError(errors.NOT_EVENT_OWNER);\n\n      await event.update({\n        description: 'description' in args ? args.description : event.description,\n        link: 'link' in args ? args.link : event.link,\n        obligatory: 'obligatory' in args ? args.obligatory : event.obligatory,\n      });\n      return true;\n    },\n\n    deleteEvent: async (_, args, context) => {\n      if (!context?.id) throw new AuthenticationError(errors.NOT_LOGGED);\n\n      const loggedUser = await userShortcut.findWithRole(context.id);\n      await checkIsProfessor(loggedUser);\n\n      const event = await eventShortcut.find(args.id, [database.models.user]);\n      if (!event) throw new UserInputError(errors.DEFAULT);\n\n      const userIsOwner = event.user.id === loggedUser.id;\n      if (!userIsOwner) throw new ForbiddenError(errors.NOT_EVENT_OWNER);\n\n      await event.update({ deleted_at: new Date() });\n      return true;\n    },\n\n    destroyEvent: async (_, args, context) => {\n      if (!context?.id) throw new AuthenticationError(errors.NOT_LOGGED);\n\n      const loggedUser = await userShortcut.findWithRole(context.id);\n      await checkIsAdmin(loggedUser);\n\n      const event = await eventShortcut.findDeleted(args.id, [database.models.user]);\n      if (!event) throw new UserInputError(errors.DEFAULT);\n\n      await event.destroy();\n      return true;\n    },\n  },\n};\n"],"file":"event.js"}